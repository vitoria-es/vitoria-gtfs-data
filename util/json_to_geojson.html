<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>JSON to CSV converter</title>
    </head>
    <body>
        <pre id="csv"></pre>
    </body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
<script>
var loadJSON = function (url, callback) {
    var xhr = new XMLHttpRequest();
    xhr.overrideMimeType('application/json');
    xhr.open('GET', url, true);
    xhr.onreadystatechange = function () {
        if (xhr.readyState == 4 && xhr.status == '200') {
            callback(xhr.responseText);
        }
    }
    xhr.send(null);
};

var buildGeojson = function (input) {
    var output = [];

    var decode = function (string) {
        var pattern = /\\u([\d\w]{4})/gi;
        return string.replace(pattern, function (match, grp) {
            return String.fromCharCode(parseInt(grp, 16));
        });
    };

    input.pontosDeParada.forEach(function (stop) {
        var feature = {
            type: 'Feature',
            id: stop.id,
            properties: {
                identificador: stop.identificador,
                descricao: decode(stop.descricao),
                logradouro: decode(stop.logradouro),
                municipio: decode(stop.municipio),
                direcao: stop.direcao
            },
            geometry: {
                type: "Point",
                coordinates: [
                    stop.longitude,
                    stop.latitude,
                ]
            }
        };
        output.push(feature);
    });

    return output;
};

var init = function () {
    loadJSON('listarPontosDeParada.json', function (response) {
        var jsonData = JSON.parse(response);
        var features = buildGeojson(jsonData);
        var collection = {
            type: "FeatureCollection",
            features: features,
        };
        document.getElementById('csv').innerHTML = JSON.stringify(collection);
    });
};

init();
</script>

</html>
